#!/bin/bash
# ===========================================================
# Security Environment — Hardening CIS/Wazuh
# ===========================================================

# Identidade e Perfil
export HOST_ROLE="base"
export PROFILE="dev" # dev = senha SSH permitida | prod = somente chave

# Estações administrativas (SSH)
export ADMIN_WORKSTATION_IPS="192.168.100.2,192.168.100.58"

# Redes VPN autorizadas (CIDR)
export VPN_NETS="10.200.254.0/24"

# Monitoramento
export WAZUH_MANAGER_IP="192.168.100.132"
export ZABBIX_SERVER_IPS="192.168.100.121"

# Portas padronizadas (sem números mágicos)
export PORT_SSH="22"
export PORT_DNS="53"
export PORT_HTTP="80"
export PORT_HTTPS="443"
export PORT_NTP="123"
export PORT_ZBX_AGENT="10050"
export PORT_ZBX_SERVER="10051"
export PORT_WAZUH_DATA="1514"
export PORT_WAZUH_CTRL="1515"

# Políticas inbound
export EXPOSE_HTTP_INBOUND="false"
export EXPOSE_HTTPS_INBOUND="false"

# Políticas outbound
export ALLOW_OUTBOUND_APT="true"
export ALLOW_OUTBOUND_DNS="true"
export ALLOW_OUTBOUND_NTP="true"
export ALLOW_OUTBOUND_WEB="true"

# Journald
export JOURNAL_SYSTEMMAXUSE="5%"
export JOURNAL_SYSTEMMAXFILESIZE="200M"
export JOURNAL_MAXRETENTION="14day"

# Kernel & Auditoria (apenas preparação)
export AUDIT_BACKLOG="32768"
export AUDIT_FAILURE_MODE="1"
export AUDIT_LOG_DIR="/var/log/audit"

# Toggle IPv6
export DISABLE_IPV6="no"

# ===========================================================
# Variáveis DERIVADAS — não editar diretamente
# ===========================================================

# Para nftables (listas com espaço)
export ADMIN_WORKSTATION_IPS_NFT="$(echo "${ADMIN_WORKSTATION_IPS}" | tr ',' ' ')"
export VPN_NETS_NFT="$(echo "${VPN_NETS}" | tr ',' ' ')"
export ZABBIX_SERVER_IPS_NFT="$(echo "${ZABBIX_SERVER_IPS}" | tr ',' ' ')"

# Fonte única de gestão
export MGMT_SOURCES="${ADMIN_WORKSTATION_IPS_NFT} ${VPN_NETS_NFT}"

# Padronização para booleanos
canon_bool() {
  case "${1,,}" in
  1 | yes | y | true | on) echo "yes" ;;
  *) echo "no" ;;
  esac
}

export EXPOSE_HTTP_INBOUND_YN="$(canon_bool "${EXPOSE_HTTP_INBOUND}")"
export EXPOSE_HTTPS_INBOUND_YN="$(canon_bool "${EXPOSE_HTTPS_INBOUND}")"
export ALLOW_OUTBOUND_APT_YN="$(canon_bool "${ALLOW_OUTBOUND_APT}")"
export ALLOW_OUTBOUND_DNS_YN="$(canon_bool "${ALLOW_OUTBOUND_DNS}")"
export ALLOW_OUTBOUND_NTP_YN="$(canon_bool "${ALLOW_OUTBOUND_NTP}")"
export ALLOW_OUTBOUND_WEB_YN="$(canon_bool "${ALLOW_OUTBOUND_WEB}")"
